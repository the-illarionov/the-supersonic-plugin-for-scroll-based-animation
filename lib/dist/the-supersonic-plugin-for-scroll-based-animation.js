var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);const s={scroll:0,screenHeight:0,rafActive:!0,rafId:0,renderedInitially:!1,config:{options:{observerRootMargin:"100px"},drivers:{}},reset(){s.scroll=0,s.rafActive=!0,s.rafId=0,s.renderedInitially=!1},initConfig(t){s.config={options:{...s.config.options,...t.options},drivers:t.drivers??{},hooks:t.hooks??{},elements:t.elements??{}}}};function i(t){throw new Error(t)}function n(t,e){return~~(t*(e=10**e))/e}const r=class t{constructor({driverId:s,cssProperty:i,start:n,end:r,unit:o,hooks:a}){e(this,"driver"),e(this,"cssProperty"),e(this,"id"),e(this,"start"),e(this,"end"),e(this,"hooks"),e(this,"value",-1),e(this,"data",{}),e(this,"unit"),e(this,"elements",new Set),this.cssProperty=i,this.start=n,this.end=r,this.unit=o??"",this.hooks=a??{},this.id=`${s}---${i}`,this.driver=c.instances.get(s),t.instances.set(this.id,this),this.driver.properties.add(this),this.hooks.onInit&&this.hooks.onInit(this)}render(){this.value=this.calculateValue(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);for(let t of this.elements)t.addProperty(this);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}calculateValue(){let t=this.start instanceof Function?this.start(this):this.start,e=this.end instanceof Function?this.end(this):this.end;const s=this.driver.progress*(e-t)+t;let i=2;return"px"===this.unit&&(i=1),n(s,i)}updateLimits(){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}static init({drivers:e}){for(let s in e)if("properties"in e[s]){if("default"in e[s].properties){const t=Object.keys(e[s].properties);let i="default";for(let e of t)"default"!==e&&matchMedia(e).matches&&(i=e);e[s].properties=e[s].properties[i]}let i=e[s].properties;for(let e in i){const n=i[e];new t({driverId:s,cssProperty:e,start:n.start,end:n.end,unit:n.unit,hooks:n.hooks})}}}static uninit(){t.instances.clear()}};e(r,"instances",new Map);let o=r;const a=class t{constructor({id:s,hooks:i}){e(this,"id"),e(this,"domElements"),e(this,"hooks"),e(this,"data",{}),e(this,"properties",new Map),e(this,"translate3d",{translateX:"0",translateY:"0",translateZ:"0"}),this.id=s,this.hooks=i??{},this.initDomElements(),this.saveInitialTranslate(),t.instances.set(this.id,this),this.hooks.onInit&&this.hooks.onInit(this)}saveInitialTranslate(){const t=window.getComputedStyle(this.domElements[0]).transform;if(t.includes("matrix")){const e=t.match(/matrix.*\((.+)\)/)[1].split(", "),s=t.includes("3d")?"3d":"2d";this.translate3d={translateX:("2d"===s?e[4]:e[12])+"px",translateY:("2d"===s?e[5]:e[13])+"px",translateZ:("2d"===s?"0":e[14])+"px"}}}initDomElements(){this.domElements=Array.from(document.querySelectorAll(this.id)),0===this.domElements.length&&i(`Can't find Element: "${this.id}"`),this.domElements.forEach((t=>{t.setAttribute("data-supersonic-type","element"),t.setAttribute("data-supersonic-element-id",this.id)}))}render(){this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);const t=this.calculateFlatProperties();for(let e in t)this.domElements.forEach((s=>{s.style.setProperty(e,t[e])}));this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}addProperty(t){if(!s.renderedInitially){const e=this.properties.get(t.cssProperty);if(e){const s=t.driver.initialDistanceToScroll,i=e.driver.initialDistanceToScroll,n=s<0,r=i<0;let o=!1;if(n||r?!n&&r&&(o=s<i):o=s>i,o)return}}this.properties.set(t.cssProperty,t),this.hooks.onAddProperty&&this.hooks.onAddProperty(this,t)}calculateFlatProperties(){const e={};let s=!1;for(let i of this.properties.values()){const{cssProperty:n,value:r,unit:o}=i,a=r+o;t.translate3dKeys.includes(n)?(this.translate3d[n]=a,s=!0):"scale"===n?(d(e),e.transform+=`scale3d(${a}, ${a}, ${a}) `):t.transformKeys.includes(n)?(d(e),e.transform+=`${n}(${a}) `):e[n]=a}return s&&(d(e),e.transform+=`translate3d(${this.translate3d.translateX}, ${this.translate3d.translateY}, ${this.translate3d.translateZ}) `),e}updateLimits(t){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this,t)}static init({drivers:e,elements:s}){for(let i in e){const n=c.instances.get(i),r=e[i].properties;for(let e in r){const a=o.instances.get(`${i}---${e}`);for(let i of r[e].elements){let e=t.instances.get(i);if(!e){let n;s&&s[i]&&s[i].hooks&&(n=s[i].hooks),e=new t({id:i,hooks:n})}n.elements.add(e),a.elements.add(e)}}}}static uninit(){t.instances.clear()}static render(){for(let e of t.activeInstances.values())e.render();t.activeInstances.clear()}};e(a,"instances",new Map),e(a,"activeInstances",new Set),e(a,"transformKeys",["perspective","scaleX","scaleY","scale","skewX","skewY","skew","rotateX","rotateY","rotate"]),e(a,"translate3dKeys",["translateX","translateY","translateZ"]);let h=a;function d(t){t.transform||(t.transform="")}const l=class t{constructor({id:s,hooks:i}){e(this,"id"),e(this,"progress",0),e(this,"active",!1),e(this,"initialDistanceToScroll",0),e(this,"data",{}),e(this,"start"),e(this,"end"),e(this,"properties",new Set),e(this,"elements",new Set),e(this,"helper"),e(this,"hooks"),this.id=s,this.hooks=i??{},this.initBorders(),this.helper=new u({driver:this}),t.instances.set(s,this),this.hooks.onInit&&this.hooks.onInit(this)}initBorders(){const t=`[data-supersonic-driver="${this.id}"]`,e=`${t}[data-supersonic-type="start"]`,s=`${t}[data-supersonic-type="end"]`;this.start=new p({domElement:document.querySelector(e),selector:e}),this.end=new p({domElement:document.querySelector(s),selector:s})}render(){const t=this.progress;if(this.progress=this.calculateProgress(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this),t!==this.progress||!s.renderedInitially){for(let t of this.properties)t.render();for(let t of this.elements)h.activeInstances.add(t);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}}calculateProgress(){let t=(s.scroll-this.start.top)/(this.end.top-this.start.top);return t=t<0?0:t>1?1:n(t,4),t}updateLimits(){this.start.updateLimits(),this.end.updateLimits(),this.end.top<this.start.top&&(this.end.top+=s.screenHeight),this.helper.updateLimits();for(let t of this.properties)t.updateLimits();for(let t of this.elements)t.updateLimits(this);this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}activate(){this.active=!0,t.activeInstances.add(this),this.hooks.onActivation&&this.hooks.onActivation(this)}deactivate(){this.active=!1,t.activeInstances.delete(this),this.hooks.onDeactivation&&this.hooks.onDeactivation(this)}static init({drivers:e}){for(let s in e)new t({id:s,hooks:e[s].hooks})}static uninit(){for(let e of t.instances.values())e.helper.uninit();t.instances.clear()}static render({useActiveDrivers:e}){const i=e?t.activeInstances.values():t.instances.values();for(let t of i)s.renderedInitially||(t.initialDistanceToScroll=t.end.top-s.scroll),t.render()}static updateLimits(){for(let e of t.instances.values())e.updateLimits()}};e(l,"instances",new Map),e(l,"activeInstances",new Set);let c=l;class p{constructor({domElement:t,selector:s}){e(this,"domElement"),e(this,"top",0),e(this,"edge","bottom"),t||i(`Can't find DOM element: ${s}"]`),"top"===t.dataset.supersonicEdge&&(this.edge="top"),this.domElement=t}updateLimits(){this.top=~~this.domElement.getBoundingClientRect().top+s.scroll,"bottom"===this.edge&&(this.top-=s.screenHeight)}}const m=class t{constructor({driver:s}){e(this,"domElement"),e(this,"driver"),this.driver=s,this.domElement=document.createElement("i");for(let e in t.styles)this.domElement.style.setProperty(e,t.styles[e]);this.domElement.setAttribute("data-supersonic-driver",s.id),this.domElement.setAttribute("data-supersonic-type","helper"),this.domElement.classList.add("supersonic-helper"),document.body.appendChild(this.domElement)}updateLimits(){let t=this.driver.start.top,e=this.driver.end.top;"bottom"===this.driver.start.edge&&(t+=s.screenHeight),"bottom"===this.driver.end.edge&&(e+=s.screenHeight),this.domElement.style.setProperty("top",t+"px"),this.domElement.style.setProperty("height",e-t+"px")}uninit(){this.domElement.remove()}};e(m,"styles",{position:"absolute",left:0,width:"1px"});let u=m;class f{constructor(t){e(this,"instance"),this.instance=new IntersectionObserver((t=>{t.forEach((t=>{const e=t.target.dataset.supersonicDriver,s=c.instances.get(e);s?t.isIntersecting?s.activate():s.deactivate():i(`Observer can't find driver "${e}"`)}))}),{rootMargin:s.config.options.observerRootMargin}),t.forEach((t=>{this.instance.observe(t)}))}uninit(){this.instance.disconnect()}}class v{constructor(t){var i;e(this,"observer",null),e(this,"onResize",null),s.initConfig(t),this.initInstances(),this.updateLimits(),this.initObserver(),this.addEventListeners(),this.render({useActiveDrivers:!1}),s.renderedInitially=!0,(null==(i=s.config.hooks)?void 0:i.onInit)&&s.config.hooks.onInit(this)}uninit(){c.uninit(),o.uninit(),h.uninit(),this.removeEventListeners(),this.observer.uninit(),this.observer=null,s.reset()}initInstances(){const t=s.config.drivers,e=s.config.elements;c.init({drivers:t}),o.init({drivers:t}),h.init({drivers:t,elements:e})}initObserver(){const t=Array.from(document.querySelectorAll('[data-supersonic-type="helper"]'));this.observer=new f(t)}render({useActiveDrivers:t}){const e=s.config.hooks;s.rafActive&&(this.updateScroll(),e.onBeforeRender&&e.onBeforeRender(),c.render({useActiveDrivers:t}),h.render(),s.rafId=requestAnimationFrame((()=>{this.render({useActiveDrivers:!0})})),e.onAfterRender&&e.onAfterRender())}updateLimits(){this.updateScreenHeight(),this.updateScroll(),c.updateLimits(),s.config.hooks.onUpdateLimits&&s.config.hooks.onUpdateLimits()}updateScroll(){s.scroll=window.scrollY||window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop}updateScreenHeight(){const t={position:"absolute",left:"0",top:"0",height:"100vh",width:"1px",zIndex:"-1",visibility:"hidden"},e=document.createElement("div");for(const s in t)e.style.setProperty(s,t[s]);document.body.appendChild(e),s.screenHeight=e.clientHeight,e.remove()}addEventListeners(){this.onResize=()=>{this.updateLimits(),this.render({useActiveDrivers:!1})},window.addEventListener("resize",this.onResize)}removeEventListeners(){window.removeEventListener("resize",this.onResize)}}e(v,"Driver",c),e(v,"Property",o),e(v,"Element",h),e(v,"Globals",s);export{v as TheSuperSonicPluginForScrollBasedAnimation};
