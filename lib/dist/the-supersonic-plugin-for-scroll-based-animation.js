var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);function s(t,e){return~~(t*(e=10**e))/e}const i=class t{constructor({driverId:s,cssProperty:i,start:n,end:o,unit:r="",hooks:h={}}){e(this,"driver"),e(this,"cssProperty"),e(this,"id"),e(this,"start"),e(this,"end"),e(this,"hooks"),e(this,"value",-1),e(this,"data",{}),e(this,"unit"),e(this,"elements",new Set),this.cssProperty=i,this.start=n,this.end=o,this.unit=r,this.hooks=h,this.id=`${s}---${i}`,this.driver=l.instances.get(s),t.instances.set(this.id,this),this.driver.properties.add(this),this.hooks.onInit&&this.hooks.onInit(this)}render(){this.value=this.calculateValue(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);for(const t of this.elements)t.addProperty(this);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}calculateValue(){const t=this.start instanceof Function?this.start(this):this.start,e=this.end instanceof Function?this.end(this):this.end,i=this.driver.progress*(e-t)+t;let n=2;return"px"===this.unit&&(n=1),s(i,n)}updateLimits(){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}static init({drivers:e}){for(const s in e)if("properties"in e[s]){if("default"in e[s].properties){const t=Object.keys(e[s].properties);let i="default";for(const e of t)"default"!==e&&matchMedia(e).matches&&(i=e);e[s].properties=e[s].properties[i]}const i=e[s].properties;for(const e in i){const n=i[e];new t({driverId:s,cssProperty:e,start:n.start,end:n.end,unit:n.unit,hooks:n.hooks})}}}static uninit(){t.instances.clear()}};e(i,"instances",new Map);let n=i;const o=class t{constructor({id:s,hooks:i,plugin:n}){if(e(this,"id"),e(this,"domElements"),e(this,"hooks"),e(this,"data",{}),e(this,"properties",new Map),e(this,"translate3d",{translateX:"0",translateY:"0",translateZ:"0"}),e(this,"plugin"),this.id=s,this.plugin=n,this.hooks=i??{},this.domElements=Array.from(document.querySelectorAll(this.id)),0===this.domElements.length)throw new Error(`Can't find Element: "${this.id}"`);this.domElements.forEach((t=>{t.setAttribute("data-supersonic-type","element"),t.setAttribute("data-supersonic-element-id",this.id)}));const o=window.getComputedStyle(this.domElements[0]).transform;if(o.includes("matrix")){const t=o.match(/matrix.*\((.+)\)/)[1].split(", "),e=o.includes("3d")?"3d":"2d";this.translate3d={translateX:`${"2d"===e?t[4]:t[12]}px`,translateY:`${"2d"===e?t[5]:t[13]}px`,translateZ:`${"2d"===e?"0":t[14]}px`}}t.instances.set(this.id,this),this.hooks.onInit&&this.hooks.onInit(this)}render(){this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);const t=this.calculateFlatProperties();for(const e in t)this.domElements.forEach((s=>{s.style.setProperty(e,t[e])}));this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}addProperty(t){if(!this.plugin.renderedInitially){const e=this.properties.get(t.cssProperty);if(e){const s=t.driver.initialDistanceToScroll,i=e.driver.initialDistanceToScroll,n=s<0,o=i<0;let r=!1;if(n||o?!n&&o&&(r=s<i):r=s>i,r)return}}this.properties.set(t.cssProperty,t),this.hooks.onAddProperty&&this.hooks.onAddProperty(this,t)}calculateFlatProperties(){const e={};let s=!1;for(const i of this.properties.values()){const{cssProperty:n,value:o,unit:r}=i,a=o+r;t.translate3dKeys.includes(n)?(this.translate3d[n]=a,s=!0):"scale"===n?(h(e),e.transform+=`scale3d(${a}, ${a}, ${a}) `):t.transformKeys.includes(n)?(h(e),e.transform+=`${n}(${a}) `):e[n]=a}return s&&(h(e),e.transform+=`translate3d(${this.translate3d.translateX}, ${this.translate3d.translateY}, ${this.translate3d.translateZ}) `),e}updateLimits(t){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this,t)}static init({drivers:e,elements:s,plugin:i}){for(const o in e){const r=l.instances.get(o),h=e[o].properties;for(const e in h){const a=n.instances.get(`${o}---${e}`);for(const n of h[e].elements){let e=t.instances.get(n);if(!e){let o;s&&s[n]&&s[n].hooks&&(o=s[n].hooks),e=new t({id:n,hooks:o,plugin:i})}r.elements.add(e),a.elements.add(e)}}}}static uninit(){t.instances.clear()}static render(){for(const e of t.activeInstances.values())e.render();t.activeInstances.clear()}};e(o,"instances",new Map),e(o,"activeInstances",new Set),e(o,"transformKeys",["perspective","scaleX","scaleY","scale","skewX","skewY","skew","rotateX","rotateY","rotate"]),e(o,"translate3dKeys",["translateX","translateY","translateZ"]);let r=o;function h(t){t.transform||(t.transform="")}const a=class t{constructor({id:s,plugin:i,start:n,end:o,hooks:r={}}){e(this,"id"),e(this,"progress",0),e(this,"active",!1),e(this,"initialDistanceToScroll",0),e(this,"data",{}),e(this,"start"),e(this,"end"),e(this,"properties",new Set),e(this,"elements",new Set),e(this,"helper"),e(this,"plugin"),e(this,"hooks"),this.id=s,this.plugin=i,this.hooks=r,this.hooks.onBeforeInit&&this.hooks.onBeforeInit(this),this.start=new d({domElement:n,plugin:this.plugin,type:"start",driver:this}),this.end=new d({domElement:o,plugin:this.plugin,type:"end",driver:this}),this.helper=new c({driver:this,plugin:i}),t.instances.set(s,this),this.hooks.onAfterInit&&this.hooks.onAfterInit(this)}render(){const t=this.progress;if(this.progress=this.calculateProgress(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this),t!==this.progress||!this.plugin.renderedInitially){for(const t of this.properties)t.render();for(const t of this.elements)r.activeInstances.add(t);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}}calculateProgress(){let t=(this.plugin.scroll-this.start.top)/(this.end.top-this.start.top);return t=t<0?0:t>1?1:s(t,4),t}updateLimits(){this.start.updateLimits(),this.end.updateLimits(),this.helper.updateLimits();for(const t of this.properties)t.updateLimits();for(const t of this.elements)t.updateLimits(this);this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}activate(){this.active=!0,t.activeInstances.add(this),this.hooks.onActivation&&this.hooks.onActivation(this)}deactivate(){this.active=!1,t.activeInstances.delete(this),this.hooks.onDeactivation&&this.hooks.onDeactivation(this)}static init({drivers:e,plugin:s}){for(const i in e)new t({id:i,hooks:e[i].hooks,plugin:s,start:e[i].start,end:e[i].end})}static uninit(){for(const e of t.instances.values())e.helper.uninit();t.instances.clear()}static render({useActiveDrivers:e,plugin:s}){const i=e?t.activeInstances.values():t.instances.values();for(const t of i)s.renderedInitially||(t.initialDistanceToScroll=t.end.top-s.scroll),t.render()}static updateLimits(){for(const e of t.instances.values())e.updateLimits()}};e(a,"instances",new Map),e(a,"activeInstances",new Set);let l=a;class d{constructor({domElement:t,plugin:s,type:i,driver:n}){if(e(this,"domElement"),e(this,"top",0),e(this,"plugin"),!t)throw new Error(`Can't find "${i}" HTMLElement for driver "${n.id}"`);this.domElement=t,this.plugin=s}updateLimits(){this.top=~~this.domElement.getBoundingClientRect().top+this.plugin.scroll}}class c{constructor({driver:t,plugin:s}){e(this,"domElement"),e(this,"driver"),e(this,"plugin"),this.driver=t,this.plugin=s,this.domElement=document.createElement("i"),this.domElement.style.position="absolute",this.domElement.style.left="0",this.domElement.style.width="1px",this.domElement.setAttribute("data-supersonic-driver",t.id),this.domElement.setAttribute("data-supersonic-type","helper"),this.domElement.classList.add("supersonic-helper"),document.body.appendChild(this.domElement)}updateLimits(){const t=this.driver.start.top+this.plugin.screenHeight,e=this.driver.end.top+this.plugin.screenHeight;this.domElement.style.setProperty("top",`${t}px`),this.domElement.style.setProperty("height",e-t+"px")}uninit(){this.domElement.remove()}}class p{constructor(t){e(this,"instance"),this.instance=new IntersectionObserver((t=>{t.forEach((t=>{const e=t.target.dataset.supersonicDriver,s=l.instances.get(e);if(!s)throw new Error(`Observer can't find driver "${e}"`);t.isIntersecting?s.activate():s.deactivate()}))})),t.forEach((t=>{this.instance.observe(t)}))}uninit(){this.instance.disconnect()}}class u{constructor({drivers:t,hooks:s={},elements:i={}}){var o,h;e(this,"scroll",0),e(this,"screenHeight",0),e(this,"renderedInitially",!1),e(this,"hooks",{}),e(this,"observer",null),e(this,"onResize",null),this.hooks=s,null!=(o=this.hooks)&&o.onBeforeInit&&this.hooks.onBeforeInit(this),l.init({drivers:t,plugin:this}),n.init({drivers:t}),r.init({drivers:t,elements:i,plugin:this}),this.updateLimits();const a=Array.from(document.querySelectorAll('[data-supersonic-type="helper"]'));this.observer=new p(a);this.onResize=function(t,e){let s;return function(){clearTimeout(s),s=setTimeout((()=>t.apply(this)),e)}}((()=>{var t;null!=(t=this.hooks)&&t.onBeforeResize&&this.hooks.onBeforeResize(this),this.updateLimits(),this.render({useActiveDrivers:!1}),this.hooks.onAfterResize&&this.hooks.onAfterResize(this)}),250),window.addEventListener("resize",this.onResize),this.render({useActiveDrivers:!1}),this.renderedInitially=!0,null!=(h=this.hooks)&&h.onAfterInit&&this.hooks.onAfterInit(this)}uninit(){l.uninit(),n.uninit(),r.uninit(),this.observer.uninit(),window.removeEventListener("resize",this.onResize)}render({useActiveDrivers:t}){this.updateScroll(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this),l.render({useActiveDrivers:t,plugin:this}),r.render(),requestAnimationFrame((()=>{this.render({useActiveDrivers:!0})})),this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}updateLimits(){this.updateScreenHeight(),this.updateScroll(),l.updateLimits()}updateScroll(){this.scroll=window.scrollY||document.documentElement.scrollTop}updateScreenHeight(){const t={position:"absolute",left:"0",top:"0",height:"100vh",width:"1px",zIndex:"-1",visibility:"hidden"},e=document.createElement("div");for(const s in t)e.style.setProperty(s,t[s]);document.body.appendChild(e),this.screenHeight=e.clientHeight,e.remove()}}e(u,"Driver",l),e(u,"Property",n),e(u,"Element",r);export{l as Driver,r as Element,n as Property,u as TheSuperSonicPlugin};
