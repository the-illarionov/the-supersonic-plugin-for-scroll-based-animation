var e=Object.defineProperty,t=(t,s,i)=>(((t,s,i)=>{s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i})(t,"symbol"!=typeof s?s+"":s,i),i);class s{constructor({id:e,animation:s}){t(this,"id"),t(this,"animation"),this.id=e,this.animation=s}render({driverProgress:e}){this.animation.currentTime=1e3*e}}class i{constructor({id:e,start:i,end:r,elements:h=[],hooks:a={}}){t(this,"id"),t(this,"progress",0),t(this,"active",!1),t(this,"data",{}),t(this,"start"),t(this,"end"),t(this,"animations",new Map),t(this,"helper"),t(this,"hooks"),this.id=e,this.hooks=a,this.hooks.onBeforeInit&&this.hooks.onBeforeInit(this),this.start=new n({domElement:i,type:"start",driver:this}),this.end=new n({domElement:r,type:"end",driver:this}),this.helper=new o({driver:this}),h.forEach((e=>{const t="string"==typeof e?e:e.selector,i=document.querySelectorAll(t);if(0===i.length)throw new Error(`Can't find element "${t}"`);i.forEach((i=>{const n=i.getAnimations();let o=[];if("string"==typeof e)o=n,o.length;else if("object"==typeof e){if(!e.animations||0===e.animations.length)throw new Error(`Can't find animations at element "${t}"`);e.animations.forEach((e=>{const t=n.find((t=>t.animationName===e));t&&o.push(t)}))}o.forEach((e=>{const i=`${t}---${e.animationName}`,n=new s({id:i,animation:e});this.animations.set(i,n)}))}))})),this.hooks.onAfterInit&&this.hooks.onAfterInit(this)}render({scroll:e,renderedInitially:t,consoleColor:s}){const i=this.progress;if(this.progress=this.calculateProgress({scroll:e,start:this.start.top,end:this.end.top}),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this),i!==this.progress||!t)for(const e of this.animations.values())e.render({driverProgress:this.progress})}calculateProgress({scroll:e,start:t,end:s}){let i=(e-t)/(s-t);return i=i<0?0:i>1?1:function(e,t){return~~(e*(t=10**t))/t}(i,3),i}updateLimits({scroll:e,screenHeight:t}){this.start.updateLimits({scroll:e}),this.end.updateLimits({scroll:e}),this.helper.updateLimits({screenHeight:t}),this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}activate(){this.active=!0,this.hooks.onActivation&&this.hooks.onActivation(this)}deactivate(){this.active=!1,this.hooks.onDeactivation&&this.hooks.onDeactivation(this)}}class n{constructor({domElement:e,type:s,driver:i}){if(t(this,"domElement"),t(this,"top",0),!e)throw new Error(`Can't find "${s}" HTMLElement for driver "${i.id}"`);this.domElement=e}updateLimits({scroll:e}){this.top=~~this.domElement.getBoundingClientRect().top+e}}class o{constructor({driver:e}){t(this,"domElement"),t(this,"driver"),this.driver=e,this.domElement=document.createElement("i"),this.domElement.style.position="absolute",this.domElement.style.left="0",this.domElement.style.width="1px",this.domElement.setAttribute("data-supersonic-driver",e.id),this.domElement.setAttribute("data-supersonic-type","helper"),this.domElement.classList.add("supersonic-helper"),document.body.appendChild(this.domElement)}updateLimits({screenHeight:e}){const t=this.driver.start.top+e,s=this.driver.end.top+e;this.domElement.style.setProperty("top",`${t}px`),this.domElement.style.setProperty("height",s-t+"px")}uninit(){this.domElement.remove()}}class r{constructor({observables:e,driverInstances:s,driverActiveInstances:i}){t(this,"instance"),this.instance=new IntersectionObserver((e=>{e.forEach((e=>{const t=e.target.dataset.supersonicDriver,n=s.get(t);if(!n)throw new Error(`Observer can't find driver "${t}"`);e.isIntersecting?(i.add(n),n.activate()):(i.delete(n),n.deactivate())}))})),e.forEach((e=>{this.instance.observe(e)}))}uninit(){this.instance.disconnect()}}class h{constructor({drivers:e,hooks:s={}}){var n,o;t(this,"scroll",0),t(this,"screenHeight",0),t(this,"renderedInitially",!1),t(this,"rafId",0),t(this,"hooks",{}),t(this,"consoleColor","#ffffff"),t(this,"observer",null),t(this,"onResize",null),t(this,"driverInstances",new Map),t(this,"driverActiveInstances",new Set),this.hooks=s,null!=(n=this.hooks)&&n.onBeforeInit&&this.hooks.onBeforeInit(this);for(const t in e){const s=new i({id:t,hooks:e[t].hooks,start:e[t].start,end:e[t].end,elements:e[t].elements});this.driverInstances.set(t,s)}this.updateLimits();const h=Array.from(document.querySelectorAll('[data-supersonic-type="helper"]'));this.observer=new r({observables:h,driverInstances:this.driverInstances,driverActiveInstances:this.driverActiveInstances});this.onResize=function(e,t){let s;return function(){clearTimeout(s),s=setTimeout((()=>e.apply(this)),t)}}((()=>{var e;null!=(e=this.hooks)&&e.onBeforeResize&&this.hooks.onBeforeResize(this),this.updateLimits(),this.render({useActiveDrivers:!1}),this.hooks.onAfterResize&&this.hooks.onAfterResize(this)}),250),window.addEventListener("resize",this.onResize),this.render({useActiveDrivers:!1}),this.renderedInitially=!0,null!=(o=this.hooks)&&o.onAfterInit&&this.hooks.onAfterInit(this)}uninit(){for(const e of this.driverInstances.values())e.helper.uninit();this.driverInstances.clear(),this.driverActiveInstances.clear(),this.observer.uninit(),cancelAnimationFrame(this.rafId),window.removeEventListener("resize",this.onResize)}render({useActiveDrivers:e}){this.updateScroll(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);const t=e?this.driverActiveInstances.values():this.driverInstances.values();for(const e of t)e.render({scroll:this.scroll,renderedInitially:this.renderedInitially,consoleColor:this.consoleColor});this.rafId=requestAnimationFrame((()=>{this.render({useActiveDrivers:!0})})),this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}updateLimits(){this.updateScreenHeight(),this.updateScroll();for(const e of this.driverInstances.values())e.updateLimits({scroll:this.scroll,screenHeight:this.screenHeight})}updateScroll(){this.scroll=window.scrollY||document.documentElement.scrollTop}updateScreenHeight(){const e={position:"absolute",left:"0",top:"0",height:"100vh",width:"1px",zIndex:"-1",visibility:"hidden"},t=document.createElement("div");for(const s in e)t.style.setProperty(s,e[s]);document.body.appendChild(t),this.screenHeight=t.clientHeight,t.remove()}}export{s as Animation,i as Driver,h as TheSuperSonicPlugin};
