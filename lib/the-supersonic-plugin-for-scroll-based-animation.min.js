var t=Object.defineProperty,e=(e,s,i)=>(((e,s,i)=>{s in e?t(e,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[s]=i})(e,"symbol"!=typeof s?s+"":s,i),i);const s={scroll:0,rafActive:!0,rafId:0,renderedInitially:!1,config:{options:{observerRootMargin:"100px"},drivers:{}},reset(){s.scroll=0,s.rafActive=!0,s.rafId=0,s.renderedInitially=!1},initConfig(t){var e,i,n;s.config={options:{...s.config.options,...t.options},drivers:null!=(e=t.drivers)?e:{},hooks:null!=(i=t.hooks)?i:{},elements:null!=(n=t.elements)?n:{}}}};function i(t){throw new Error(t)}function n(t,e){return~~(t*(e=10**e))/e}const r=class{constructor({driverId:t,cssProperty:s,start:i,end:n,unit:o,hooks:a}){e(this,"driver"),e(this,"cssProperty"),e(this,"id"),e(this,"start"),e(this,"end"),e(this,"hooks"),e(this,"value",-1),e(this,"data",{}),e(this,"unit"),e(this,"elements",new Set),this.cssProperty=s,this.start=i,this.end=n,this.unit=null!=o?o:"",this.hooks=null!=a?a:{},this.id=`${t}---${s}`,this.driver=c.instances.get(t),r.instances.set(this.id,this),this.driver.properties.add(this),this.hooks.onInit&&this.hooks.onInit(this)}render(){this.value=this.calculateValue(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);for(let t of this.elements)t.addProperty(this);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}calculateValue(){let t=this.start instanceof Function?this.start(this):this.start,e=this.end instanceof Function?this.end(this):this.end;const s=this.driver.progress*(e-t)+t;let i=2;return"px"===this.unit&&(i=1),n(s,i)}updateLimits(){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}static init({drivers:t}){for(let e in t)if("properties"in t[e]){if("default"in t[e].properties){const s=Object.keys(t[e].properties);let i="default";for(let t of s)"default"!==t&&matchMedia(t).matches&&(i=t);t[e].properties=t[e].properties[i]}let s=t[e].properties;for(let t in s){const i=s[t];new r({driverId:e,cssProperty:t,start:i.start,end:i.end,unit:i.unit,hooks:i.hooks})}}}static uninit(){r.instances.clear()}};let o=r;e(o,"instances",new Map);const a=class{constructor({id:t,hooks:s}){e(this,"id"),e(this,"domElements"),e(this,"hooks"),e(this,"data",{}),e(this,"properties",new Map),e(this,"translate3d",{translateX:"0",translateY:"0",translateZ:"0"}),this.id=t,this.hooks=null!=s?s:{},this.initDomElements(),this.saveInitialTranslate(),a.instances.set(this.id,this),this.hooks.onInit&&this.hooks.onInit(this)}saveInitialTranslate(){const t=window.getComputedStyle(this.domElements[0]).transform;if(t.includes("matrix")){const e=t.match(/matrix.*\((.+)\)/)[1].split(", "),s=t.includes("3d")?"3d":"2d";this.translate3d={translateX:("2d"===s?e[4]:e[12])+"px",translateY:("2d"===s?e[5]:e[13])+"px",translateZ:("2d"===s?"0":e[14])+"px"}}}initDomElements(){this.domElements=Array.from(document.querySelectorAll(this.id)),0===this.domElements.length&&i(`Can't find Element: "${this.id}"`),this.domElements.forEach((t=>{t.setAttribute("data-supersonic-type","element"),t.setAttribute("data-supersonic-element-id",this.id)}))}render(){this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this);const t=this.calculateFlatProperties();for(let e in t)this.domElements.forEach((s=>{s.style.setProperty(e,t[e])}));this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}addProperty(t){if(!s.renderedInitially){const e=this.properties.get(t.cssProperty);if(e){const s=t.driver.initialDistanceToScroll,i=e.driver.initialDistanceToScroll,n=s<0,r=i<0;let o=!1;if(n||r?!n&&r&&(o=s<i):o=s>i,o)return}}this.properties.set(t.cssProperty,t),this.hooks.onAddProperty&&this.hooks.onAddProperty(this,t)}calculateFlatProperties(){const t={};let e=!1;for(let s of this.properties.values()){const{cssProperty:i,value:n,unit:r}=s,o=n+r;a.translate3dKeys.includes(i)?(this.translate3d[i]=o,e=!0):"scale"===i?(d(t),t.transform+=`scale3d(${o}, ${o}, ${o}) `):a.transformKeys.includes(i)?(d(t),t.transform+=`${i}(${o}) `):t[i]=o}return e&&(d(t),t.transform+=`translate3d(${this.translate3d.translateX}, ${this.translate3d.translateY}, ${this.translate3d.translateZ}) `),t}updateLimits(t){this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this,t)}static init({drivers:t,elements:e}){for(let s in t){const i=c.instances.get(s),n=t[s].properties;for(let t in n){const r=o.instances.get(`${s}---${t}`);for(let s of n[t].elements){let t=a.instances.get(s);if(!t){let i;e&&e[s]&&e[s].hooks&&(i=e[s].hooks),t=new a({id:s,hooks:i})}i.elements.add(t),r.elements.add(t)}}}}static uninit(){a.instances.clear()}static render(){for(let t of a.activeInstances.values())t.render();a.activeInstances.clear()}};let h=a;function d(t){t.transform||(t.transform="")}e(h,"instances",new Map),e(h,"activeInstances",new Set),e(h,"transformKeys",["perspective","scaleX","scaleY","scale","skewX","skewY","skew","rotateX","rotateY","rotate"]),e(h,"translate3dKeys",["translateX","translateY","translateZ"]);const l=class{constructor({id:t,hooks:s}){e(this,"id"),e(this,"progress",0),e(this,"active",!1),e(this,"initialDistanceToScroll",0),e(this,"data",{}),e(this,"start"),e(this,"end"),e(this,"properties",new Set),e(this,"elements",new Set),e(this,"helper"),e(this,"hooks"),this.id=t,this.hooks=null!=s?s:{},this.initBorders(),this.helper=new m({driver:this}),l.instances.set(t,this),this.hooks.onInit&&this.hooks.onInit(this)}initBorders(){const t=`[data-supersonic-driver="${this.id}"]`,e=`${t}[data-supersonic-type="start"]`,s=`${t}[data-supersonic-type="end"]`;this.start=new p({domElement:document.querySelector(e),selector:e}),this.end=new p({domElement:document.querySelector(s),selector:s})}render(){const t=this.progress;if(this.progress=this.calculateProgress(),this.hooks.onBeforeRender&&this.hooks.onBeforeRender(this),t!==this.progress||!s.renderedInitially){for(let t of this.properties)t.render();for(let t of this.elements)h.activeInstances.add(t);this.hooks.onAfterRender&&this.hooks.onAfterRender(this)}}calculateProgress(){let t=(s.scroll-this.start.top)/(this.end.top-this.start.top);return t=t<0?0:t>1?1:n(t,4),t}updateLimits(){this.start.updateLimits(),this.end.updateLimits(),this.end.top<this.start.top&&(this.end.top+=window.innerHeight),this.helper.updateLimits();for(let t of this.properties)t.updateLimits();for(let t of this.elements)t.updateLimits(this);this.hooks.onUpdateLimits&&this.hooks.onUpdateLimits(this)}activate(){this.active=!0,l.activeInstances.add(this),this.hooks.onActivation&&this.hooks.onActivation(this)}deactivate(){this.active=!1,l.activeInstances.delete(this),this.hooks.onDeactivation&&this.hooks.onDeactivation(this)}static init({drivers:t}){for(let e in t)new l({id:e,hooks:t[e].hooks})}static uninit(){for(let t of l.instances.values())t.helper.uninit();l.instances.clear()}static render({useActiveDrivers:t}){const e=t?l.activeInstances.values():l.instances.values();for(let t of e)s.renderedInitially||(t.initialDistanceToScroll=t.end.top-s.scroll),t.render()}static updateLimits(){for(let t of l.instances.values())t.updateLimits()}};let c=l;e(c,"instances",new Map),e(c,"activeInstances",new Set);class p{constructor({domElement:t,selector:s}){e(this,"domElement"),e(this,"top",0),e(this,"edge","bottom"),t||i(`Can't find DOM element: ${s}"]`),"top"===t.dataset.supersonicEdge&&(this.edge="top"),this.domElement=t}updateLimits(){this.top=this.domElement.getBoundingClientRect().top+s.scroll,"bottom"===this.edge&&(this.top-=window.innerHeight)}}const u=class{constructor({driver:t}){e(this,"domElement"),e(this,"driver"),this.driver=t,this.domElement=document.createElement("i");for(let t in u.styles)this.domElement.style.setProperty(t,u.styles[t]);this.domElement.setAttribute("data-supersonic-driver",t.id),this.domElement.setAttribute("data-supersonic-type","helper"),this.domElement.classList.add("supersonic-helper"),document.body.appendChild(this.domElement)}updateLimits(){let t=this.driver.start.top,e=this.driver.end.top;"bottom"===this.driver.start.edge&&(t+=window.innerHeight),"bottom"===this.driver.end.edge&&(e+=window.innerHeight),this.domElement.style.setProperty("top",t+"px"),this.domElement.style.setProperty("height",e-t+"px")}uninit(){this.domElement.remove()}};let m=u;e(m,"styles",{position:"absolute",left:0,width:"1px"});class f{constructor(t){e(this,"instance"),this.instance=new IntersectionObserver((t=>{t.forEach((t=>{const e=t.target.dataset.supersonicDriver,s=c.instances.get(e);s?t.isIntersecting?s.activate():s.deactivate():i(`Observer can't find driver "${e}"`)}))}),{rootMargin:s.config.options.observerRootMargin}),t.forEach((t=>{this.instance.observe(t)}))}uninit(){this.instance.disconnect()}}class v{constructor(t){var i;e(this,"observer",null),e(this,"resizeWrapper",null),s.initConfig(t),this.initInstances(),this.updateLimits(),this.initObserver(),this.addEventListeners(),this.render({useActiveDrivers:!1}),s.renderedInitially=!0,(null==(i=s.config.hooks)?void 0:i.onInit)&&s.config.hooks.onInit(this)}uninit(){c.uninit(),o.uninit(),h.uninit(),this.removeEventListeners(),this.observer.uninit(),this.observer=null,s.reset()}initInstances(){const t=s.config.drivers,e=s.config.elements;c.init({drivers:t}),o.init({drivers:t}),h.init({drivers:t,elements:e})}initObserver(){const t=Array.from(document.querySelectorAll('[data-supersonic-type="helper"]'));this.observer=new f(t)}render({useActiveDrivers:t}){const e=s.config.hooks;s.rafActive&&(this.updateScroll(),e.onBeforeRender&&e.onBeforeRender(),c.render({useActiveDrivers:t}),h.render(),s.rafId=requestAnimationFrame((()=>{this.render({useActiveDrivers:!0})})),e.onAfterRender&&e.onAfterRender())}updateLimits(){this.updateScroll(),c.updateLimits(),s.config.hooks.onUpdateLimits&&s.config.hooks.onUpdateLimits()}updateScroll(){s.scroll=window.pageYOffset||window.scrollY||document.documentElement.scrollTop||document.body.scrollTop}addEventListeners(){this.resizeWrapper=function(t){let e;return()=>{clearTimeout(e),e=setTimeout((()=>{t.apply(this)}),500)}}((()=>{s.rafActive=!0,this.updateLimits(),this.render({useActiveDrivers:!1})})),window.addEventListener("resize",this.onResize.bind(this))}removeEventListeners(){window.removeEventListener("resize",this.onResize)}onResize(){cancelAnimationFrame(s.rafId),s.rafActive=!1,this.resizeWrapper()}}e(v,"Driver",c),e(v,"Property",o),e(v,"Element",h),e(v,"Globals",s);export{v as default};
